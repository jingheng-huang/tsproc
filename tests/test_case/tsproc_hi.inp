START SETTINGS
#  CONTEXT pest_input
  CONTEXT all
  DATE_FORMAT mm/dd/yyyy
END SETTINGS

#--------------------------------------------------------------------------
# ** READ IN DATA
#--------------------------------------------------------------------------

####################################################################
# Read Observed flows and levels from an SSF file
####################################################################

#==> Read in BLACK EARTH CREEK AT BLACK EARTH DATA
START GET_MUL_SERIES_SSF
  CONTEXT all
  FILE gsflow_sroff_04506500.ssf
  SITE 04506500
  NEW_SERIES_NAME ro6500i
END GET_MUL_SERIES_SSF

START GET_MUL_SERIES_SSF
  CONTEXT all
  FILE gsflow_ssres_04506500.ssf
  SITE 04506500
  NEW_SERIES_NAME if6500i
END GET_MUL_SERIES_SSF

START GET_MUL_SERIES_SSF
  CONTEXT all
  FILE gsflow_gwres_04506500.ssf
  SITE 04506500
  NEW_SERIES_NAME gw6500i
END GET_MUL_SERIES_SSF

START GET_MUL_SERIES_SSF
  CONTEXT all
  FILE gsflow_sumq_04506500.ssf
  SITE 04506500
  NEW_SERIES_NAME q6500i
END GET_MUL_SERIES_SSF

START GET_MUL_SERIES_SSF
  CONTEXT all
  FILE Q_BEC_BE_6500.ssf
  SITE 04506500
  NEW_SERIES_NAME obsQ6500i
END GET_MUL_SERIES_SSF


####################################################################
# Reduce observed time series
####################################################################

#==> BLACK EARTH CREEK AT BLACK EARTH
START REDUCE_TIME_SPAN
  CONTEXT all
  SERIES_NAME obsQ6500i
  NEW_SERIES_NAME obsQ6500r
  DATE_1 01/01/1985
  DATE_2 06/01/2006
END REDUCE_TIME_SPAN

####################################################################
# Clean observed time series
####################################################################

#==> BLACK EARTH CREEK AT BLACK EARTH
START SERIES_CLEAN
  CONTEXT all
  SERIES_NAME obsQ6500r
  NEW_SERIES_NAME obsQ6500
  SUBSTITUTE_VALUE delete
  UPPER_ERASE_BOUNDARY 0.1
END SERIES_CLEAN

####################################################################
# Modeled flows are interpolated to the times of observed flows.
####################################################################

#==> BLACK EARTH CREEK AT BLACK EARTH
START NEW_TIME_BASE
  CONTEXT all
  SERIES_NAME ro6500i
  TB_SERIES_NAME obsQ6500
  NEW_SERIES_NAME ro6500
END NEW_TIME_BASE

START NEW_TIME_BASE
  CONTEXT all
  SERIES_NAME if6500i
  TB_SERIES_NAME obsQ6500
  NEW_SERIES_NAME if6500
END NEW_TIME_BASE

START NEW_TIME_BASE
  CONTEXT all
  SERIES_NAME gw6500i
  TB_SERIES_NAME obsQ6500
  NEW_SERIES_NAME gw6500
END NEW_TIME_BASE

START NEW_TIME_BASE
  CONTEXT all
  SERIES_NAME q6500i
  TB_SERIES_NAME obsQ6500
  NEW_SERIES_NAME q6500
END NEW_TIME_BASE

####################################################################
# Apply digital filter
# NOTE: digital filter REMOVES the BASEFLOW COMPONENT!!
#       Therefore, the output reflects the surface runoff
#       and interflow components.
####################################################################

#==> BLACK EARTH CREEK AT BLACK EARTH
START DIGITAL_FILTER
  CONTEXT all
  FILTER_TYPE baseflow_separation
  SERIES_NAME obsQ6500
  NEW_SERIES_NAME obsST6500
  ALPHA 0.95
  PASSES 1
  CLIP_INPUT yes
  CLIP_ZERO yes
END DIGITAL_FILTER

####################################################################
# Subtract storm and interflow components from total flow
####################################################################

#START SERIES_EQUATION
#  CONTEXT all
#  NEW_SERIES_NAME obsGW6500
#  EQUATION obsQ6500 - obsST6500
#END SERIES_EQUATION

#==> Create simulated "stormflow" by adding interflow and surface runoff
#==> BLACK EARTH CREEK AT BLACK EARTH
START SERIES_EQUATION
  CONTEXT all
  NEW_SERIES_NAME st6500
  EQUATION ro6500 + if6500
END SERIES_EQUATION

####################################################################
# Log Transform Observed and Modeled TOTAL flows
####################################################################

#==> BLACK EARTH CREEK AT BLACK EARTH
START SERIES_EQUATION
  CONTEXT all
  NEW_SERIES_NAME lnobsQ6500
  EQUATION LOG(obsQ6500 + 0.001)
END SERIES_EQUATION

START SERIES_EQUATION
  CONTEXT all
  NEW_SERIES_NAME lnq6500
  EQUATION LOG(q6500 + 0.001)
END SERIES_EQUATION

####################################################################
# Exceedence times are calculated for the modeled time series.
# BLACK EARTH CREEK AT BLACK EARTH
####################################################################

START EXCEEDENCE_TIME
  CONTEXT all
  SERIES_NAME q6500
  NEW_E_TABLE_NAME Eq6500
  EXCEEDENCE_TIME_UNITS days
  FLOW 20
  FLOW 25
  FLOW 30
  FLOW 35
  FLOW 40
  FLOW 45
  FLOW 50
  FLOW 60
  FLOW 75
  FLOW 100
  FLOW 200
  FLOW 300
  FLOW 500

END EXCEEDENCE_TIME

####################################################################
# Exceedence times are calculated for the observed time series
# BLACK EARTH CREEK AT BLACK EARTH
####################################################################

START EXCEEDENCE_TIME
  CONTEXT all
  SERIES_NAME obsQ6500
  NEW_E_TABLE_NAME EobsQ6500
  EXCEEDENCE_TIME_UNITS days
  FLOW 20
  FLOW 25
  FLOW 30
  FLOW 35
  FLOW 40
  FLOW 45
  FLOW 50
  FLOW 60
  FLOW 75
  FLOW 100
  FLOW 200
  FLOW 300
  FLOW 500

END EXCEEDENCE_TIME

####################################################################
# Exceedence times are calculated for the OBSERVED STORM flow series.
# BLACK EARTH CREEK AT BLACK EARTH
####################################################################

START EXCEEDENCE_TIME
  CONTEXT all
  SERIES_NAME obsST6500
  NEW_E_TABLE_NAME EobsST6500
  EXCEEDENCE_TIME_UNITS days
  FLOW 20
  FLOW 25
  FLOW 30
  FLOW 35
  FLOW 40
  FLOW 45
  FLOW 50
  FLOW 60
  FLOW 75
  FLOW 100
  FLOW 200
  FLOW 300
  FLOW 500
  FLOW 750
END EXCEEDENCE_TIME

####################################################################
# Exceedence times are calculated for the MODELED STORM time series
# BLACK EARTH CREEK AT BLACK EARTH
####################################################################

START EXCEEDENCE_TIME
  CONTEXT all
  SERIES_NAME st6500
  NEW_E_TABLE_NAME Est6500
  EXCEEDENCE_TIME_UNITS days
  FLOW 20
  FLOW 25
  FLOW 30
  FLOW 35
  FLOW 40
  FLOW 45
  FLOW 50
  FLOW 60
  FLOW 75
  FLOW 100
  FLOW 200
  FLOW 300
  FLOW 500
  FLOW 750
END EXCEEDENCE_TIME

####################################################################
# Compare time series  - Black Earth Creek at Black Earth
####################################################################

START SERIES_COMPARE
  CONTEXT all
  SERIES_NAME_SIM q6500
  SERIES_NAME_OBS obsQ6500
  NEW_C_TABLE_NAME Cq6500
  BIAS yes
  RELATIVE_BIAS yes
  STANDARD_ERROR yes
  RELATIVE_STANDARD_ERROR yes
  NASH_SUTCLIFFE yes
  COEFFICIENT_OF_EFFICIENCY yes
  INDEX_OF_AGREEMENT yes
  EXPONENT 1
  DATE_1 01/01/1985
  TIME_1 00:00:00
  DATE_2 06/01/2006
  TIME_2 23:59:59
END SERIES_COMPARE

####################################################################
# Flow volumes are accumulated for the MODELED time series.
####################################################################

#==> BLACK EARTH CREEK AT BLACK EARTH
START VOLUME_CALCULATION
  CONTEXT all
  SERIES_NAME q6500
  NEW_V_TABLE_NAME Vq6500
  FLOW_TIME_UNITS sec
  DATE_FILE date85_06.dat
END VOLUME_CALCULATION

START VOLUME_CALCULATION
  CONTEXT all
  SERIES_NAME obsQ6500
  NEW_V_TABLE_NAME VobsQ6500
  FLOW_TIME_UNITS sec
  DATE_FILE date85_06.dat
END VOLUME_CALCULATION

#==> calc simulated STORM FLOW VOLUME
START VOLUME_CALCULATION
  CONTEXT all
  SERIES_NAME st6500
  NEW_V_TABLE_NAME Vst6500
  FLOW_TIME_UNITS sec
  DATE_FILE date85_06.dat
END VOLUME_CALCULATION

START VOLUME_CALCULATION
  CONTEXT all
  SERIES_NAME obsST6500
  NEW_V_TABLE_NAME VobsST6500
  FLOW_TIME_UNITS sec
  DATE_FILE date85_06.dat
END VOLUME_CALCULATION

START HYDROLOGIC_INDICES
  CONTEXT all
  SERIES_NAME obsQ6500
  NEW_G_TABLE_NAME obs_hyd_indx
  DRAINAGE_AREA 41.6
  STREAM_CLASSIFICATION groundwater_perennial
  FLOW_COMPONENT average_magnitude
  FLOW_COMPONENT low_flow_magnitude
  FLOW_COMPONENT low_flow_duration
  FLOW_COMPONENT low_flow_frequency
END HYDROLOGIC_INDICES

START HYDROLOGIC_INDICES
  CONTEXT all
  SERIES_NAME q6500
  NEW_G_TABLE_NAME sim_hyd_indx
  DRAINAGE_AREA 41.6
  STREAM_CLASSIFICATION groundwater_perennial
  FLOW_COMPONENT average_magnitude
  FLOW_COMPONENT low_flow_magnitude
  FLOW_COMPONENT low_flow_duration
  FLOW_COMPONENT low_flow_frequency
END HYDROLOGIC_INDICES

START LIST_OUTPUT
  CONTEXT all
  FILE bec_obs_tsproc.out
  SERIES_NAME lnobsQ6500
  V_TABLE_NAME VobsQ6500
  V_TABLE_NAME VobsST6500
  G_TABLE_NAME obs_hyd_indx
  SERIES_FORMAT long
END LIST_OUTPUT

START LIST_OUTPUT
  CONTEXT all
  FILE bec_tables_tsproc.out
  C_TABLE_NAME Cq6500
END LIST_OUTPUT

START LIST_OUTPUT
  CONTEXT all
  FILE bec_sim_tsproc.out
  SERIES_NAME lnq6500
  V_TABLE_NAME Vq6500
  V_TABLE_NAME Vst6500
  G_TABLE_NAME sim_hyd_indx
  SERIES_FORMAT long
END LIST_OUTPUT

####################################################################
# Write PEST input files
####################################################################

START WRITE_PEST_FILES
  CONTEXT pest_input
  NEW_PEST_CONTROL_FILE bec_pest_hi.pst
  AUTOMATIC_USER_INTERVENTION yes
  TEMPLATE_FILE par2par_base.tpl
  MODEL_INPUT_FILE par2par_base.dat
  NEW_INSTRUCTION_FILE simulated_values.ins

############ Time Series Observations #############
#==> BLACK EARTH CREEK AT BLACK EARTH
  OBSERVATION_SERIES_NAME lnobsQ6500
  MODEL_SERIES_NAME lnq6500
#  SERIES_WEIGHTS_EQUATION 1.0E-3 * sqrt(OCq_bec_be)
  SERIES_WEIGHTS_EQUATION 1.0E-4 * obsQ6500**2

############ Comparison of Calculated Volumes #############
  OBSERVATION_V_TABLE_NAME VobsQ6500
  MODEL_V_TABLE_NAME Vq6500
  V_TABLE_WEIGHTS_EQUATION 7.0E-7


############ Comparison of Calculated STORM Volumes #############
  OBSERVATION_V_TABLE_NAME VobsST6500
  MODEL_V_TABLE_NAME Vst6500
  V_TABLE_WEIGHTS_EQUATION 7.0e-7

############ Comparison of HYDROLOGIC INDICES #############
  OBSERVATION_G_TABLE_NAME obs_hyd_indx
  MODEL_G_TABLE_NAME sim_hyd_indx
  G_TABLE_WEIGHTS_EQUATION 1.0

############ Other Data #############
  PARAMETER_GROUP_FILE bec_param.groups
  PARAMETER_DATA_FILE bec_param.data
  MODEL_COMMAND_LINE modelcmd_hi.bat

END WRITE_PEST_FILES
